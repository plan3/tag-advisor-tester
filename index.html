<html>
    <head>
    <script src="https://cdn.jsdelivr.net/clipboard.js/1.5.16/clipboard.min.js"></script>
    <script>

    var selfURL = window.location.href;
    var authURL = 'https://auth.api.plan3.se/auth';

    function getParameterByName(name) {
        var url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

    function redirToAuth() {
        window.location.replace(authURL + '?callback=' + encodeURIComponent(selfURL));
    }

	function loaded() {
		var params = new URLSearchParams(location.search.slice(1));
		var profileRef = getParameterByName('profileRef');
		if (profileRef) {
			var xhr = new XMLHttpRequest();
			xhr.open('get', profileRef, true);
			xhr.responseType = 'json';
			xhr.onload = function() {
				var status = xhr.status;
				if (status == 200) {
                    document.getElementById('jwt').setAttribute('value', xhr.response.jwt);
				} else {
					console.log(xhr);
				}
			};
			xhr.send();
		} else { 
            redirToAuth();
		}
	}

    function testAdvisor() {
      var xhr = new XMLHttpRequest();
      xhr.open('POST', 'https://tag-counselor.api.plan3.se/advise');
      xhr.setRequestHeader('Authorization', 'Plan3JWT ' + document.getElementById('jwt').getAttribute('value'));
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.onload = function() {
          var status = xhr.status;
          if (status == 200) {
              document.getElementById('informationArea').innerHTML = JSON.stringify(xhr.response);
          } else {

          }
      };
      xhr.send(JSON.stringify({
          title: document.getElementById('articleTitle').getAttribute('value'),
          resources: [
          {
            type: 'text',
            text: document.getElementById('articleText').innerHTML
          }
          ],
          tags: []
      }));

    }
    </script>
    </head>
    <body onLoad="loaded()">
        <h1>Tag counselor tester</h1>
        <input id="articleTitle">
        <textarea id="articleText" cols="100" rows="40"></textarea>
        <form>
            <input type="hidden" value="" id="jwt"/> 
        </form>
        <button id="submit" onclick="testAdvisor();">Test</button>
        <div id="informationArea"></div>
    </body>
</html>
